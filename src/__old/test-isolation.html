<!DOCTYPE html>
<html>
<head>
    <title>Test Isolation</title>
    <script>
        let tests = [];
        let currentTest = null;
        
        function test(code){
            tests.push(async () => {
                console.log(`Running test ${tests.length}`);
                try {
                    await code();
                    console.log(`Test ${tests.length} passed`);
                } catch (e) {
                    console.error(`Test ${tests.length} failed:`, e);
                }
            });
        }
        
        function mock(path, response) {
            // Mock implementation
        }
        
        function find(selector) {
            return document.querySelector(selector);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function assertEq(actual, expected) {
            if (actual !== expected) {
                throw `Expected ${expected} but got ${actual}`;
            }
        }
    </script>
    <script src="fiximod-compat-standalone-fixed.js"></script>
</head>
<body>
    <!-- Simulate test 14 -->
    <div class="test" id="test14">
        <h3>Test 14: Event-based aborting</h3>
        <button fx-action="/demo" fx-swap="innerHTML">Button 1</button>
        <script>
            test(async () => {
                let button = document.querySelector('#test14 button');
                button.addEventListener("fx:before", (evt) => {
                    console.log('Test 14: Calling abort');
                    evt.detail.cfg.abort();
                    evt.detail.cfg.confirm = async() => {
                        await sleep(1);
                        // No return, so returns undefined
                    }
                });
                button.click();
                await sleep(50);
                assertEq(button.innerText, "Button 1");
            });
        </script>
    </div>
    
    <!-- Simulate test 15 -->
    <div class="test" id="test15">
        <h3>Test 15: Another test</h3>
        <button fx-action="/demo2" fx-swap="innerHTML">Button 2</button>
        <script>
            test(async () => {
                let button = document.querySelector('#test15 button');
                button.click();
                await sleep(50);
                // Check if this works
            });
        </script>
    </div>
    
    <script>
        // Track all events globally
        let eventCount = 0;
        ['fx:config', 'fx:before', 'fx:after', 'fx:error', 'fx:finally'].forEach(eventName => {
            document.addEventListener(eventName, (evt) => {
                eventCount++;
                console.log(`Event #${eventCount}: ${eventName} on ${evt.target.id || evt.target.tagName}`);
                if (eventCount > 20) {
                    console.error('Too many events - possible infinite loop!');
                    throw new Error('Infinite loop detected');
                }
            });
        });
        
        // Run tests sequentially
        setTimeout(async () => {
            for (let i = 0; i < tests.length; i++) {
                currentTest = tests[i];
                await currentTest();
                console.log('---');
            }
        }, 100);
    </script>
</body>
</html>